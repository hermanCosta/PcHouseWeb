@page "/service-orders/create"
@using PcHouseStore.Domain.Enums
@using PcHouseStore.Domain.Models
@using PcHouseStore.Web.Models
@using PcHouseStore.Web.Services
@inject ServiceOrderService ServiceOrderService
@inject CustomerService CustomerService
@inject DeviceService DeviceService
@inject FaultService FaultService
@inject PaymentService PaymentService
@inject CashMovementService CashMovementService
@inject PcHouseStore.Web.Services.ProductService ProductService
@inject ApiService ApiService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Create Service Order</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <h2>Create Service Order</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/service-orders">Service Orders</a></li>
                    <li class="breadcrumb-item active">Create</li>
                </ol>
            </nav>
        </div>
    </div>

    <EditForm Model="orderModel" OnValidSubmit="HandleValidSubmitAsync">
        <DataAnnotationsValidator />

        <div class="row g-3">
            <!-- LEFT COLUMN -->
            <div class="col-lg-8">
                <!-- Customer Section -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">1. Customer Information</h5>
                        <button type="button" class="btn btn-sm btn-primary" @onclick="ShowCreateCustomerModal">
                            <i class="oi oi-plus"></i> New Customer
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Select Customer *</label>
                            <div class="input-group">
                                <select class="form-select" @bind="orderModel.CustomerId" @bind:after="OnCustomerChanged" required>
                                    <option value="">-- Select Customer --</option>
                                    @if (customers != null)
                                    {
                                        @foreach (var customer in customers)
                                        {
                                            <option value="@customer.CustomerId">@(customer.PersonName ?? "N/A") - @(customer.PersonPhone ?? "N/A")</option>
                                        }
                                    }
                                </select>
                                <button type="button" class="btn btn-outline-secondary" @onclick="RefreshCustomers">
                                    <i class="oi oi-reload"></i>
                                </button>
                            </div>
                            @if (orderModel.CustomerId.HasValue && selectedCustomer != null)
                            {
                                <div class="mt-2 p-2 bg-light rounded">
                                    <small>
                                        <strong>@(selectedCustomer.PersonName ?? "N/A")</strong><br/>
                                        Phone: @(selectedCustomer.PersonPhone ?? "N/A")
                                        @if (!string.IsNullOrEmpty(selectedCustomer.PersonEmail))
                                        {
                                            <span> | Email: @selectedCustomer.PersonEmail</span>
                                        }
                                    </small>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Device Section -->
                @if (orderModel.CustomerId.HasValue)
                {
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">2. Device Information</h5>
                            <button type="button" class="btn btn-sm btn-primary" @onclick="ShowRegisterDeviceModal">
                                <i class="oi oi-plus"></i> Register Device
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Select Device</label>
                                <select class="form-select" @bind="orderModel.DeviceId" @bind:after="OnDeviceChanged">
                                    <option value="">-- Select Existing Device --</option>
                                    @if (customerDevices != null)
                                    {
                                        @foreach (var device in customerDevices)
                                        {
                                            <option value="@device.DeviceId">@device.DisplayName @(!string.IsNullOrEmpty(device.SerialNumber) ? $"({device.SerialNumber})" : "")</option>
                                        }
                                    }
                                </select>
                            </div>

                            @if (!orderModel.DeviceId.HasValue)
                            {
                                <div class="alert alert-info">
                                    <i class="oi oi-info"></i> No device selected. Click "Register Device" to add a new device.
                                </div>
                            }
                            else if (selectedDevice != null)
                            {
                                <div class="p-3 bg-light rounded">
                                    <strong>@selectedDevice.DisplayName</strong>
                                    @if (!string.IsNullOrEmpty(selectedDevice.SerialNumber))
                                    {
                                        <div>Serial: @selectedDevice.SerialNumber</div>
                                    }
                                    @if (!string.IsNullOrEmpty(selectedDevice.Description))
                                    {
                                        <div class="text-muted">@selectedDevice.Description</div>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Fault Section -->
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">3. Fault / Issue</h5>
                            <button type="button" class="btn btn-sm btn-primary" @onclick="ShowCreateFaultModal">
                                <i class="oi oi-plus"></i> New Fault
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Select Fault</label>
                                <select class="form-select" @bind="selectedFaultId" @bind:after="OnFaultChanged">
                                    <option value="">-- Select Fault --</option>
                                    @if (faults != null)
                                    {
                                        @foreach (var fault in faults)
                                        {
                                            <option value="@fault.FaultId">@fault.Description</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Additional Notes</label>
                                <textarea class="form-control" rows="3" @bind="orderModel.CheckInNotes" 
                                    placeholder="Describe the issue or work to be performed in detail..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Service Lines Section -->
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">4. Services / Repairs</h5>
                            <button type="button" class="btn btn-sm btn-primary" @onclick="ShowAddServiceModal">
                                <i class="oi oi-plus"></i> Add Service
                            </button>
                        </div>
                        <div class="card-body">
                            @if (orderModel.Lines == null || !orderModel.Lines.Any())
                            {
                                <div class="alert alert-warning">
                                    <i class="oi oi-warning"></i> No services added yet. Click "Add Service" to add repair services.
                                </div>
                            }
                            else
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Service</th>
                                                <th>Qty</th>
                                                <th>Price</th>
                                                <th>Total</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var line in orderModel.Lines)
                                            {
                                                <tr>
                                                    <td>@line.Description</td>
                                                    <td>@line.Quantity</td>
                                                    <td>€@line.UnitPrice.ToString("F2")</td>
                                                    <td>€@line.LineTotal.ToString("F2")</td>
                                                    <td>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                            @onclick="() => RemoveServiceLine(line)">
                                                            <i class="oi oi-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                        <tfoot>
                                            <tr class="fw-bold">
                                                <td colspan="3">Total:</td>
                                                <td>€@orderModel.TotalAmount.ToString("F2")</td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Deposit Section -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0">5. Deposit Payment (Optional)</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="hasDeposit" @bind="hasDeposit" />
                                <label class="form-check-label" for="hasDeposit">
                                    Customer will pay a deposit
                                </label>
                            </div>

                            @if (hasDeposit)
                            {
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Deposit Amount *</label>
                                            <InputNumber class="form-control" @bind-Value="depositAmount" 
                                                step="0.01" min="0" max="@orderModel.TotalAmount" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Payment Method *</label>
                                            <select class="form-select" @bind="depositPaymentMethodId">
                                                <option value="">-- Select Payment Method --</option>
                                                @if (paymentMethods != null)
                                                {
                                                    @foreach (var method in paymentMethods)
                                                    {
                                                        <option value="@method.PaymentMethodId">@method.MethodCode</option>
                                                    }
                                                }
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0">6. Additional Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Estimated Completion</label>
                                        <InputDate class="form-control" @bind-Value="estimatedCompletion" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Warranty (days)</label>
                                        <InputNumber class="form-control" @bind-Value="orderModel.WarrantyDays" min="0" />
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Internal Notes</label>
                                <textarea class="form-control" rows="2" @bind="orderModel.Notes" 
                                    placeholder="Any internal notes about this order..."></textarea>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- RIGHT COLUMN - Summary -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header">
                        <h5 class="mb-0">Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-6">Order #</dt>
                            <dd class="col-6">@orderModel.OrderNumber</dd>
                            
                            <dt class="col-6">Status</dt>
                            <dd class="col-6">
                                <span class="badge bg-secondary">@orderModel.Status</span>
                            </dd>
                            
                            <dt class="col-6">Customer</dt>
                            <dd class="col-6">
                                @if (selectedCustomer != null)
                                {
                                    <small>@(selectedCustomer.PersonName ?? "N/A")</small>
                                }
                                else
                                {
                                    <small class="text-muted">Not selected</small>
                                }
                            </dd>
                            
                            <dt class="col-6">Device</dt>
                            <dd class="col-6">
                                @if (selectedDevice != null)
                                {
                                    <small>@selectedDevice.DisplayName</small>
                                }
                                else
                                {
                                    <small class="text-muted">Not selected</small>
                                }
                            </dd>
                            
                            <dt class="col-6">Total</dt>
                            <dd class="col-6">€@orderModel.TotalAmount.ToString("F2")</dd>
                            
                            @if (hasDeposit && depositAmount > 0)
                            {
                                <dt class="col-6">Deposit</dt>
                                <dd class="col-6 text-success">-€@depositAmount.ToString("F2")</dd>
                                
                                <dt class="col-6">Balance Due</dt>
                                <dd class="col-6">€@((orderModel.TotalAmount - depositAmount).ToString("F2"))</dd>
                            }
                            else
                            {
                                <dt class="col-6">Balance Due</dt>
                                <dd class="col-6">€@orderModel.BalanceDue.ToString("F2")</dd>
                            }
                            
                            <dt class="col-6">Placed</dt>
                            <dd class="col-6"><small>@orderModel.PlacedAt?.ToLocalTime().ToString("dd MMM HH:mm")</small></dd>
                        </dl>

                        <hr />

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-secondary" @onclick="Cancel">
                                <i class="oi oi-x"></i> Cancel
                            </button>
                            <button type="submit" class="btn btn-primary" disabled="@(isSubmitting || !CanSubmit())">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                }
                                <i class="oi oi-check"></i> Create Order & Print
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </EditForm>
</div>

<!-- Create Customer Modal -->
@if (showCreateCustomerModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Customer</h5>
                    <button type="button" class="btn-close" @onclick="CloseCreateCustomerModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">First Name *</label>
                                <input type="text" class="form-control" @bind="newPerson.FirstName" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Last Name *</label>
                                <input type="text" class="form-control" @bind="newPerson.LastName" />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Mobile Number *</label>
                                <input type="tel" class="form-control" @bind="newPerson.PhoneMobile" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" @bind="newPerson.Email" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseCreateCustomerModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="CreateCustomer" disabled="@creatingCustomer">
                        @if (creatingCustomer)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        Create Customer
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Register Device Modal -->
@if (showRegisterDeviceModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Register Device</h5>
                    <button type="button" class="btn-close" @onclick="CloseRegisterDeviceModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Brand *</label>
                        <input type="text" class="form-control" @bind="newDevice.Brand" placeholder="e.g., Apple, Samsung" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Model *</label>
                        <input type="text" class="form-control" @bind="newDevice.Model" placeholder="e.g., iPhone 14, Galaxy S23" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Serial Number</label>
                        <input type="text" class="form-control" @bind="newDevice.SerialNumber" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" rows="2" @bind="newDevice.Description"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseRegisterDeviceModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="RegisterDevice" disabled="@registeringDevice">
                        @if (registeringDevice)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        Register Device
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Create Fault Modal -->
@if (showCreateFaultModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Fault</h5>
                    <button type="button" class="btn-close" @onclick="CloseCreateFaultModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Code</label>
                        <input type="text" class="form-control" @bind="newFault.Code" placeholder="Optional fault code" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description *</label>
                        <textarea class="form-control" rows="3" @bind="newFault.Description" placeholder="Describe the fault..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseCreateFaultModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="CreateFault" disabled="@creatingFault">
                        @if (creatingFault)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        Create Fault
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Add Service Modal -->
@if (showAddServiceModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Service / Repair</h5>
                    <button type="button" class="btn-close" @onclick="CloseAddServiceModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Service *</label>
                        <select class="form-select" @bind="selectedServiceId">
                            <option value="">-- Select Service --</option>
                            @if (services != null)
                            {
                                @foreach (var service in services)
                                {
                                    <option value="@service.ProductServiceId">@service.Name - €@service.Price.ToString("F2")</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" @bind="serviceDescription" 
                            placeholder="Additional description (optional)" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity *</label>
                        <InputNumber class="form-control" @bind-Value="serviceQuantity" min="1" step="1" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAddServiceModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="AddService">
                        Add Service
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private CreateOrderRequest orderModel = new()
    {
        CompanyId = 1,
        CustomerId = null,
        OrderType = OrderType.Service.ToString(),
        OrderNumber = $"SRV-{DateTime.UtcNow:yyyyMMddHHmmss}",
        Currency = "EUR",
        TotalAmount = 0m,
        TotalVatAmount = 0m,
        BalanceDue = 0m,
        Notes = null,
        CreatedByEmployeeId = 1,
        SalesChannel = null,
        DeviceId = null,
        TechnicianId = null,
        CheckInNotes = null,
        EstimatedCompletion = null,
        PlacedAt = DateTime.UtcNow,
        WarrantyDays = 90,
        Status = OrderStatus.Created,
        Lines = new List<OrderLineRequest>()
    };

    // Data
    private List<CustomerResponse>? customers;
    private CustomerResponse? selectedCustomer;
    private List<Device>? customerDevices;
    private Device? selectedDevice;
    private List<Fault>? faults;
    private long? selectedFaultId;
    private List<PcHouseStore.Domain.Models.ProductService>? services;
    private List<PaymentMethod>? paymentMethods;

    // Modals
    private bool showCreateCustomerModal;
    private bool showRegisterDeviceModal;
    private bool showCreateFaultModal;
    private bool showAddServiceModal;

    // Forms
    private Person newPerson = new();
    private long? newCustomerCompanyId = 1;
    private bool newCustomerMarketingOptIn = false;
    private Device newDevice = new();
    private Fault newFault = new();

    // Service selection
    private long? selectedServiceId;
    private string serviceDescription = string.Empty;
    private int serviceQuantity = 1;

    // Deposit
    private bool hasDeposit;
    private decimal depositAmount;
    private long? depositPaymentMethodId;

    // Other
    private DateTime? estimatedCompletion;
    private bool isSubmitting;
    private bool creatingCustomer;
    private bool registeringDevice;
    private bool creatingFault;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        await Task.WhenAll(
            LoadCustomersAsync(),
            LoadFaultsAsync(),
            LoadServicesAsync(),
            LoadPaymentMethodsAsync()
        );
    }

    private async Task LoadCustomersAsync()
    {
        try
        {
            customers = (await CustomerService.GetCustomersAsync(orderModel.CompanyId))?.ToList();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Failed to load customers: {ex.Message}");
        }
    }

    private async Task RefreshCustomers()
    {
        await LoadCustomersAsync();
        StateHasChanged();
    }

    private async Task OnCustomerChanged()
    {
        selectedCustomer = customers?.FirstOrDefault(c => c.CustomerId == orderModel.CustomerId);
        if (selectedCustomer != null)
        {
            await LoadCustomerDevicesAsync();
        }
        else
        {
            customerDevices = null;
            selectedDevice = null;
            orderModel.DeviceId = null;
        }
        StateHasChanged();
    }

    private async Task LoadCustomerDevicesAsync()
    {
        if (orderModel.CustomerId.HasValue)
        {
            try
            {
                customerDevices = (await DeviceService.GetDevicesByCustomerAsync(orderModel.CustomerId.Value))?.ToList();
                selectedDevice = customerDevices?.FirstOrDefault(d => d.DeviceId == orderModel.DeviceId);
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Failed to load devices: {ex.Message}");
            }
        }
    }

    private async Task OnDeviceChanged()
    {
        selectedDevice = customerDevices?.FirstOrDefault(d => d.DeviceId == orderModel.DeviceId);
        StateHasChanged();
    }

    private async Task LoadFaultsAsync()
    {
        try
        {
            faults = (await FaultService.GetFaultsAsync())?.ToList();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Failed to load faults: {ex.Message}");
        }
    }

    private void OnFaultChanged()
    {
        StateHasChanged();
    }

    private async Task LoadServicesAsync()
    {
        try
        {
            services = (await ProductService.GetProductsAsync(orderModel.CompanyId))?.ToList();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Failed to load services: {ex.Message}");
        }
    }

    private async Task LoadPaymentMethodsAsync()
    {
        try
        {
            paymentMethods = (await ApiService.GetListAsync<PaymentMethod>($"api/paymentmethods?companyId={orderModel.CompanyId}"))?.ToList();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Failed to load payment methods: {ex.Message}");
        }
    }

    // Customer Modal
    private void ShowCreateCustomerModal() => showCreateCustomerModal = true;
    private void CloseCreateCustomerModal()
    {
        showCreateCustomerModal = false;
        newPerson = new();
        newCustomerCompanyId = 1;
        newCustomerMarketingOptIn = false;
    }

    private async Task CreateCustomer()
    {
        if (string.IsNullOrWhiteSpace(newPerson.FirstName) || string.IsNullOrWhiteSpace(newPerson.LastName) || 
            string.IsNullOrWhiteSpace(newPerson.PhoneMobile))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Please fill in all required fields.");
            return;
        }

        creatingCustomer = true;
        StateHasChanged();

        try
        {
            // TODO: Create Person first via PersonService/Person API endpoint
            // For now, this assumes PersonId is provided or needs to be created separately
            // This is a temporary solution - Person creation should be handled via API
            if (newPerson.PersonId == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Person must be created first. Please implement PersonService or set PersonId.");
                return;
            }

            var request = new CreateCustomerRequest(
                newPerson.PersonId,
                newCustomerCompanyId,
                newCustomerMarketingOptIn
            );

            var created = await CustomerService.CreateCustomerAsync(request);
            if (created != null)
            {
                await LoadCustomersAsync();
                orderModel.CustomerId = created.CustomerId;
                await OnCustomerChanged();
                CloseCreateCustomerModal();
                await JSRuntime.InvokeVoidAsync("alert", "Customer created successfully!");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error creating customer: {ex.Message}");
        }
        finally
        {
            creatingCustomer = false;
            StateHasChanged();
        }
    }

    // Device Modal
    private void ShowRegisterDeviceModal()
    {
        if (!orderModel.CustomerId.HasValue)
        {
            JSRuntime.InvokeVoidAsync("alert", "Please select a customer first.");
            return;
        }
        newDevice = new Device { CustomerId = orderModel.CustomerId.Value };
        showRegisterDeviceModal = true;
    }

    private void CloseRegisterDeviceModal()
    {
        showRegisterDeviceModal = false;
        newDevice = new();
    }

    private async Task RegisterDevice()
    {
        if (string.IsNullOrWhiteSpace(newDevice.Brand) || string.IsNullOrWhiteSpace(newDevice.Model))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Brand and Model are required.");
            return;
        }

        registeringDevice = true;
        StateHasChanged();

        try
        {
            var created = await DeviceService.CreateDeviceAsync(newDevice);
            if (created != null)
            {
                await LoadCustomerDevicesAsync();
                orderModel.DeviceId = created.DeviceId;
                await OnDeviceChanged();
                CloseRegisterDeviceModal();
                await JSRuntime.InvokeVoidAsync("alert", "Device registered successfully!");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error registering device: {ex.Message}");
        }
        finally
        {
            registeringDevice = false;
            StateHasChanged();
        }
    }

    // Fault Modal
    private void ShowCreateFaultModal()
    {
        newFault = new();
        showCreateFaultModal = true;
    }

    private void CloseCreateFaultModal()
    {
        showCreateFaultModal = false;
        newFault = new();
    }

    private async Task CreateFault()
    {
        if (string.IsNullOrWhiteSpace(newFault.Description))
        {
            await JSRuntime.InvokeVoidAsync("alert", "Description is required.");
            return;
        }

        creatingFault = true;
        StateHasChanged();

        try
        {
            var created = await FaultService.CreateFaultAsync(newFault);
            if (created != null)
            {
                await LoadFaultsAsync();
                selectedFaultId = created.FaultId;
                CloseCreateFaultModal();
                await JSRuntime.InvokeVoidAsync("alert", "Fault created successfully!");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error creating fault: {ex.Message}");
        }
        finally
        {
            creatingFault = false;
            StateHasChanged();
        }
    }

    // Service Modal
    private void ShowAddServiceModal()
    {
        selectedServiceId = null;
        serviceDescription = string.Empty;
        serviceQuantity = 1;
        showAddServiceModal = true;
    }

    private void CloseAddServiceModal()
    {
        showAddServiceModal = false;
    }

    private void AddService()
    {
        if (!selectedServiceId.HasValue)
        {
            JSRuntime.InvokeVoidAsync("alert", "Please select a service.");
            return;
        }

        var service = services?.FirstOrDefault(s => s.ProductServiceId == selectedServiceId.Value);
        if (service == null) return;

        var line = new OrderLineRequest(
            CatalogItemId: 0, // We'll need to map ProductService to CatalogItem
            Description: string.IsNullOrWhiteSpace(serviceDescription) ? service.Name : serviceDescription,
            Quantity: serviceQuantity,
            UnitPrice: service.Price,
            VatRate: 0m, // Assuming no VAT for services
            VatAmount: 0m,
            LineTotal: service.Price * serviceQuantity,
            RefurbItemId: null,
            FulfilmentStatus: OrderFulfilmentStatus.Pending
        );

        if (orderModel.Lines == null)
        {
            orderModel.Lines = new List<OrderLineRequest>();
        }

        orderModel.Lines.Add(line);
        RecalculateTotals();
        CloseAddServiceModal();
    }

    private void RemoveServiceLine(OrderLineRequest line)
    {
        orderModel.Lines?.Remove(line);
        RecalculateTotals();
    }

    private void RecalculateTotals()
    {
        if (orderModel.Lines == null || !orderModel.Lines.Any())
        {
            orderModel.TotalAmount = 0m;
            orderModel.TotalVatAmount = 0m;
            orderModel.BalanceDue = 0m;
        }
        else
        {
            orderModel.TotalAmount = orderModel.Lines.Sum(l => l.LineTotal);
            orderModel.TotalVatAmount = orderModel.Lines.Sum(l => l.VatAmount);
            orderModel.BalanceDue = orderModel.TotalAmount - (hasDeposit ? depositAmount : 0m);
        }
    }

    private bool CanSubmit()
    {
        return orderModel.CustomerId.HasValue && 
               orderModel.DeviceId.HasValue &&
               orderModel.Lines != null && 
               orderModel.Lines.Any() &&
               (!hasDeposit || (depositAmount > 0 && depositPaymentMethodId.HasValue));
    }

    private async Task HandleValidSubmitAsync()
    {
        if (!CanSubmit())
        {
            await JSRuntime.InvokeVoidAsync("alert", "Please complete all required fields.");
            return;
        }

        isSubmitting = true;
        StateHasChanged();

        try
        {
            orderModel.OrderType = OrderType.Service.ToString();
            orderModel.EstimatedCompletion = estimatedCompletion;
            orderModel.BalanceDue = orderModel.TotalAmount - (hasDeposit ? depositAmount : 0m);

            // Create the order
            var created = await ServiceOrderService.CreateServiceOrderAsync(orderModel);
            if (created == null)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Failed to create service order.");
                return;
            }

            // If deposit was paid, create payment and cash movement
            if (hasDeposit && depositAmount > 0 && depositPaymentMethodId.HasValue)
            {
                var selectedPaymentMethod = paymentMethods?.FirstOrDefault(pm => pm.PaymentMethodId == depositPaymentMethodId.Value);
                
                var payment = new Payment
                {
                    CompanyId = orderModel.CompanyId,
                    OrderId = created.OrderId,
                    PaymentMethodId = depositPaymentMethodId.Value,
                    PaymentType = PaymentType.Deposit,
                    Amount = depositAmount,
                    NetCash = selectedPaymentMethod?.MethodCode == PayMethod.Cash ? depositAmount : 0m,
                    NetCard = selectedPaymentMethod?.MethodCode != PayMethod.Cash ? depositAmount : 0m,
                    EmployeeId = orderModel.CreatedByEmployeeId,
                    ProcessedAt = DateTime.UtcNow,
                    Notes = $"Deposit payment for service order {created.OrderNumber}"
                };

                var createdPayment = await PaymentService.CreatePaymentAsync(payment);
                
                // Create cash movement if payment method is cash
                if (createdPayment != null && selectedPaymentMethod?.MethodCode == PayMethod.Cash)
                {
                    var cashMovement = new CashMovement
                    {
                        CompanyId = orderModel.CompanyId,
                        EmployeeId = orderModel.CreatedByEmployeeId,
                        MovementType = CashMovementType.CashIn,
                        Amount = depositAmount,
                        RelatedPaymentId = createdPayment.PaymentId,
                        Reason = $"Deposit payment for service order {created.OrderNumber}",
                        OccurredAt = DateTime.UtcNow
                    };
                    
                    await CashMovementService.CreateCashMovementAsync(cashMovement);
                }
            }

            // Add fault if selected
            if (selectedFaultId.HasValue)
            {
                // Note: This would need to be added via the API - for now we'll just note it
                // You may need to create an OrderFault endpoint
            }

            await JSRuntime.InvokeVoidAsync("alert", "Service order created successfully! Print receipt?");
            
            // Navigate to order detail or print
            Navigation.NavigateTo($"/service-orders/{created.OrderId}");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error creating service order: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/service-orders");
    }
}
